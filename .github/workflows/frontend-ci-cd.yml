name: Frontend CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-ci-cd.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-ci-cd.yml'

jobs:
  test:
    name: ðŸ§ª Test Frontend
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ðŸ“¥ Install dependencies
      working-directory: ./frontend
      run: npm ci

    - name: ðŸ” TypeScript type check
      working-directory: ./frontend
      run: npm run type-check

    - name: ðŸŽ¨ Lint code
      working-directory: ./frontend
      run: npm run lint

    - name: ðŸ—ï¸ Build application
      working-directory: ./frontend
      run: npm run build

    - name: ðŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist/
        retention-days: 5

  e2e-test:
    name: ðŸŽ­ E2E Tests
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ðŸ“¥ Install dependencies
      working-directory: ./frontend
      run: npm ci

    - name: ðŸŽ­ Install Playwright browsers
      working-directory: ./frontend
      run: npx playwright install --with-deps

    - name: ðŸ§ª Run E2E tests
      working-directory: ./frontend
      run: npm run test
      env:
        PLAYWRIGHT_BASE_URL: http://localhost:3000

    - name: ðŸ“¤ Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-results
        path: frontend/test-results/
        retention-days: 7

    - name: ðŸ“¤ Upload HTML report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-html-report
        path: frontend/test-results/html-report/
        retention-days: 7

  deploy:
    name: ðŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: write
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ðŸ“¥ Install dependencies
      working-directory: ./frontend
      run: npm ci

    - name: ðŸ—ï¸ Build for production
      working-directory: ./frontend
      run: npm run build
      env:
        NODE_ENV: production

    - name: ðŸš€ Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./frontend/dist
        force_orphan: true

  lighthouse:
    name: ðŸ  Lighthouse Performance Audit
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ  Run Lighthouse CI
      uses: treosh/lighthouse-ci-action@v10
      with:
        urls: |
          https://djyalu.github.io/ai_video_creator/
        budgetPath: frontend/.lighthouserc.json
        uploadArtifacts: true
        temporaryPublicStorage: true

  notify:
    name: ðŸ“¢ Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy, lighthouse]
    if: always() && github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ðŸ“¢ Create deployment summary
      run: |
        echo "## ðŸŽ¬ AI Video Creator Frontend Deployment" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Deployment Status" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… **Successfully deployed to GitHub Pages**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Live URL:** https://djyalu.github.io/ai_video_creator/" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“– **API Docs:** https://ai-video-creator-irf1.onrender.com/docs" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Deployment failed**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "- Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- E2E Tests: ${{ needs.e2e-test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Deployment: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Lighthouse: ${{ needs.lighthouse.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ Features Available" >> $GITHUB_STEP_SUMMARY
        echo "- âœ¨ Text-to-Video Generation" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ–¼ï¸ Image-to-Video Animation" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“Š Real-time Job Status Tracking" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“± Responsive Design" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ§ª Comprehensive E2E Testing" >> $GITHUB_STEP_SUMMARY